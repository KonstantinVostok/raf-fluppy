<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Shoe</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: url('raf_simons_face.jpg') no-repeat center center/cover;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        canvas {
            background: transparent;
            display: block;
        }
        #overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="overlay">
        <p>Game Over! Score: <span id="finalScore">0</span></p>
        <button id="restartGame">Play Again</button>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 320;
        canvas.height = 480;
        const shoeImg = new Image();
        shoeImg.src = 'raf_shoe.png';
        let shoe = { x: 50, y: 150, width: 40, height: 30, dy: 0 };
        let pipes = [];
        let gravity = 0.5, lift = -8;
        let score = 0;
        let gameOver = false;
        let overlay = document.getElementById('overlay');
        let finalScoreEl = document.getElementById('finalScore');
        document.getElementById('restartGame').addEventListener('click', restartGame);

        function drawShoe() {
            ctx.drawImage(shoeImg, shoe.x, shoe.y, shoe.width, shoe.height);
        }

        function updateGame() {
            if (!gameOver) {
                shoe.dy += gravity;
                shoe.y += shoe.dy;
                if (shoe.y + shoe.height > canvas.height) endGame();
                drawShoe();
                requestAnimationFrame(updateGame);
            }
        }

        function endGame() {
            gameOver = true;
            finalScoreEl.textContent = score;
            overlay.style.display = 'flex';
            autoSubmitScore();
        }

        function restartGame() {
            shoe.y = 150;
            shoe.dy = 0;
            score = 0;
            gameOver = false;
            overlay.style.display = 'none';
            updateGame();
        }

        function autoSubmitScore() {
            let playerName = "Anonymous";
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                const user = Telegram.WebApp.initDataUnsafe.user;
                playerName = user.first_name + (user.last_name ? " " + user.last_name : "");
            }
            fetch('http://localhost:3000/submit-score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: playerName, score: score })
            })
            .then(response => response.json())
            .catch(err => console.error("Ошибка при отправке результата:", err));
        }

        document.addEventListener('keydown', () => {
            if (!gameOver) shoe.dy = lift;
        });
        canvas.addEventListener('click', () => {
            if (!gameOver) shoe.dy = lift;
        });

        updateGame();
    </script>
</body>
</html>
